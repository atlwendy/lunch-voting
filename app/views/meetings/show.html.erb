<% provide(:title, "Show meeting") %>

<p id="notice" style="margin-top: 5px; padding-top: 5px"><%= notice %></p>

<div class="content">
  <div class="allthingstop" id="top">
    <div class="toptitle" id="toptitle">
      <h1><%= @meeting.title %></h1>
      <h5><%= @meeting.description %></h5>
    </div>
    <div id="question">
    
      <div class="areyougoing" id="repeatable">
        <h3>Are you going?</h3>
        <button id='rsvpYes' onclick="going('Yes')">Yes</button>
        <button id='rsvpNo' onclick="going('No')">No</button>
        <button id='rsvpMaybe' onclick="going('Maybe')">Maybe</button>
      </div>
    
      <% if @going == 'nothing' %>
        <h3>You were not invited </h3>
      <% else %>
        <h3>Your RSVP: <%=@going%></h3>
      <% end %>
      <button id="change" onclick="changeMind()"> Changed your mind? </button>
    
    </div>
  </div>
  <div id="event-content">
    <ul class="dividedList">
      <li id="when">
        <i class="icon icon-calendar"></i>
        <h3><%= @meeting.date.in_time_zone.strftime("%a, %b %d, %Y") %></h3>
        <p class="timetext"><%= @meeting.date.in_time_zone.strftime("%l:%M %p") %></p>

  <h3><%=@meeting.users.size%> people are going
  <% if @inGroup %> 
  (<%= link_to 'edit member', :select_members, :class=>"editinh3" %>):</h3>
  <% end %>
  <ul>
  <%# @meeting.users.sort_by{|x| x.username}.each do |user| %>
    <%# if @inGroup %>
      <!-- <li class="userlink"><%#= link_to user.username, user %></li> -->
    <%# else %>
      <%#= user.username %>
    <% #end %>
  <%# end %>
  <% @userlist.each do |key, value| %>

    <% if value.include?('Y') %>
      <li style="list-style: none">
      <img src="/assets/tick.gif"> <%=key %>
      </li>
    <% end %>
  <% end %>
  </ul>

<p>
  <div id="editr">
	<h3>Restaurant candidates and votes
  <% if @inGroup %>
	(<%= link_to 'edit restaurant', :select_restaurants, :class=>"editinh3" %>):</h3>
  <% end %>
</div>

<div id = "restaurant_table">
	<%= render partial: "restaurant_list", locals: {meeting_mrs: @meeting_mrs, uid: @uid} %>
</div>
		
</div>
<br>
<%= link_to raw('<span class="glyphicon glyphicon-pencil"></span>'), edit_meeting_path(@meeting) %> |
<%= link_to raw('<span class="glyphicon glyphicon-trash"></span>'), @meeting, method: :delete, data: { confirm: 'Are you sure?' } %> |
<%= link_to raw('<span class="glyphicon glyphicon-arrow-left"></span>'), meetings_path %>
<script>

$(document).ready(function(){
  var going = "<%=@going%>";
  if (going != ''){
    $("#repeatable").hide();
  }
})

var user = '<%= @user %>';
function changeVote(direction, mrs_id){
  var direction = direction;
  var member = <%=@inGroup%>
  if (! user || ! member) { 
    $("#editr").append("<div style='color: red'>You have to login or be the group's member to vote!</div>");
    return
  }
  
  updateVote(direction, mrs_id);
}

function updateVote(vote, mrs_id) {
  var uid = '<%=@uid%>';
  var id = '<%=@meeting_id%>';
  var url = "../meetings/" + id + "/" + "update_vote";
  $.ajax({
    url: url,
    type: "GET",
    data: {
      uid: uid, 
      mrs_id: mrs_id, 
      vote: vote, 
      id: id
    },
    datatype: "json",
    success: function(data, textStatus, xhr){
      $("#restaurant_table").html(data)
    },
    error: function(request, status, error){
      console.log(error)
      console.log(status)
    },
  });
}

function going(decision) {
  var uid = '<%=@uid%>';
  var id = '<%=@meeting_id%>';
  var url = "../meetings/" + id + "/" + "set_decision";

  $.ajax({
    url: url,
    type: "GET",
    data: {
      uid: uid,
      id: id,
      decision: decision
    },
    datatype: "json",
    success: function(data, textStatus, xhr) {
      var div = document.getElementById("question");
      //div.parentNode.removeChild(div);
      $("#repeatable").remove();
      var iDiv = document.createElement('div');
      iDiv.id="iQuestion"    
      iDiv.innerHTML = "<h3>Your RSVP: " + decision + "</h3>" + ' <button id="change" onclick="changeMind()"> Changed your mind? </button>';      
      document.getElementById("top").appendChild(iDiv);

    }
  });
}

function changeMind() {
  var currentDiv = document.getElementById("question");
  var repeatable = document.getElementById("repeatable");
  
  //currentDiv.parentNode.removeChild(currentDiv);
  $("#question").empty();
  $("#iQuestion").remove();
  var cdiv = document.createElement('div');
  cdiv.class="areyougoing"
  cdiv.id = "repeatable"
  // jQuery('<div/>', {
  //   id: 'repeatable',
  //   class: 'areyougoing',
  //   innerHTML: "<h3>Are you going?</h3><button id='rsvpYes' onclick='going(\"Yes\")'>Yes</button> <button id='rsvpNo' onclick='going(\"No\")'>No</button> <button id='rsvpMaybe' onclick='going(\"Maybe\")'>Maybe</button>"
  // }).appendTo("#top");
  cdiv.innerHTML = "<h3>Are you going?</h3><button id='rsvpYes' onclick='going(\"Yes\")'>Yes</button> <button id='rsvpNo' onclick='going(\"No\")'>No</button> <button id='rsvpMaybe' onclick='going(\"Maybe\")'>Maybe</button>"
  document.getElementById("question").appendChild(cdiv);

}

</script>