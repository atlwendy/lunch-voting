<% provide(:title, "Show meeting") %>
<p id="notice"><%= notice %></p>

<p>
  <strong>Title:</strong>
  <%= @meeting.title %>
</p>

<p>
  <strong>Description:</strong>
  <%= @meeting.description %>
</p>

<p>
  <strong>Date:</strong>
  <%= @meeting.date %>
</p>

<p>
  <strong>Members</strong> 
  (<%= link_to 'edit member', :select_members %>)
  <strong>:</strong>
  <ul>
  <% @meeting.users.each do |user| %>
  <li><%= link_to user.username, user %></li>
  <% end %>
  </ul>
</p>

<p>
  <div id="editr">
	<strong>Restaurants</strong>
	(<%= link_to 'edit restaurant', :select_restaurants%>)
	<strong>:</strong>
</div>
	<table class='vote' id='editr'>
    <% @meeting_mrs.each do |mrs| %>
      <%
      vote_count = mrs.vote_count
      my_vote = mrs.votes.find {|v| v.user_id == @uid }
      up_arrow_class = 'arrow-up'
      down_arrow_class = 'arrow-down'

      if my_vote && my_vote.vote_counts > 0 then
        up_arrow_class = 'arrow-uped'
      end
      if my_vote && my_vote.vote_counts < 0 then
        down_arrow_class = 'arrow-downed'
      end
      %>
      <tr>
        <td class="<%= up_arrow_class %>"
          id='<%= "uparrow#{mrs.id}" %>' 
          onclick="changeVote('up', <%= mrs.id %>)">
        </td>
        <td rowspan="3" class="restname">
          <%= mrs.restaurant.name %>
        </td>
      </tr>
      <tr>
        <td class="votenumber" id='<%="vnumber#{mrs.id}"%>'>
          <%= vote_count %>
        </td>
      </tr>
      <tr>
        <td class="<%= down_arrow_class %>"
          id='<%= "downarrow#{mrs.id}" %>' 
          onclick="changeVote('down', <%= mrs.id %>)">
        </td>
      </tr>
    <% end %>
	</table>
		

<%= link_to 'Edit', edit_meeting_path(@meeting) %> |
<%= link_to 'Back', meetings_path %>

<script>

var user = '<%= @user %>';
function changeVote(direction, mrs_id){
  var direction = direction;
  var member = <%=@inGroup%>
  if (! user || ! member) { 
    $("#editr").append("<div style='color: red'>You have to login or be the group's member to vote!</div>");
    return
  }
  
  updateVote(direction, mrs_id);
}

function updateVote(vote, mrs_id) {
  var uid = '<%=@uid%>';
  var id = '<%=@meeting_id%>';
  var url = "../meetings/" + id + "/" + "update_vote";
  $.ajax({
    url: url,
    type: "GET",
    data: {
      uid: uid, 
      mrs_id: mrs_id, 
      vote: vote, 
      id: id
    },
    datatype: "json",
    success: function(data, textStatus, xhr){
      if (data) {
        var counts = Number($("#vnumber" + mrs_id).html());
        if (vote == 'up') {
          counts++;
          voteUp(mrs_id);
        }
        else {
          counts--;
          voteDown(mrs_id);
        }
        $("#vnumber"+mrs_id).html(counts);
      }                
      else {
        alert("Something went wrong. Please contact your admin")
      }
    },
    error: function(request, status, error){
      console.log(error)
      console.log(status)
    },
  });
}

function voteUp(mrsId){
  $("#uparrow"+mrsId).addClass('arrow-uped').removeClass('arrow-up');
  if ($("#downarrow"+mrsId).hasClass('arrow-downed')) {
    $("#downarrow"+mrsId).addClass('arrow-down').removeClass('arrow-downed');
  }
}

function voteDown(mrsId){
  $("#downarrow"+mrsId).addClass('arrow-downed').removeClass('arrow-down');
  if ($("#uparrow"+mrsId).hasClass('arrow-uped')) {
    $("#uparrow"+mrsId).addClass('arrow-up').removeClass('arrow-uped');
  }
}
</script>